# راهنمای سیستم پشتیبان‌گیری و بازیابی دیتابیس ربات اینستاگرام

این راهنما توضیح می‌دهد که چگونه از سیستم پشتیبان‌گیری و بازیابی دیتابیس استفاده کنید. این سیستم به صورت خودکار از دیتابیس پشتیبان‌گیری می‌کند و در صورت بروز مشکل، آن را بازیابی می‌کند.

## پوشه‌ها و فایل‌های جدید

- **پوشه `database_backups`**: این پوشه حاوی فایل‌های پشتیبان دیتابیس است.
- **فایل `db_backup.py`**: اسکریپت اصلی پشتیبان‌گیری و بازیابی.
- **فایل `db_recovery.py` (به‌روزرسانی شده)**: اسکریپت بررسی سلامت دیتابیس و بازیابی در صورت نیاز.

## نحوه کارکرد

### پشتیبان‌گیری خودکار

سیستم به صورت خودکار در فواصل زمانی مشخص (هر 6 ساعت) از دیتابیس پشتیبان می‌گیرد. فایل‌های پشتیبان در پوشه `database_backups` با نام `instagrambot_backup_YYYYMMDD_HHMMSS.sql` ذخیره می‌شوند.

### بازیابی خودکار

اگر سیستم تشخیص دهد که دیتابیس دچار مشکل شده است (عدم امکان اتصال، عدم وجود جداول و غیره)، به صورت خودکار تلاش می‌کند دیتابیس را از آخرین پشتیبان در دسترس بازیابی کند.

### نگهداری پشتیبان‌ها

سیستم حداکثر 5 فایل پشتیبان را نگهداری می‌کند و فایل‌های قدیمی‌تر را به صورت خودکار حذف می‌کند.

## دستورات دستی

در صورت نیاز به استفاده دستی از سیستم پشتیبان‌گیری و بازیابی، می‌توانید از دستورات زیر استفاده کنید:

### پشتیبان‌گیری دستی

```bash
python -c "from db_backup import create_backup; print(create_backup())"
```

### بازیابی دستی

```bash
# بازیابی از آخرین پشتیبان
python -c "from db_backup import restore_backup; print(restore_backup())"

# بازیابی از یک فایل پشتیبان خاص
python -c "from db_backup import restore_backup; print(restore_backup('database_backups/instagrambot_backup_20250330_120000.sql'))"
```

### بررسی سلامت دیتابیس

```bash
python -c "from db_backup import check_db_integrity; print(check_db_integrity())"
```

## پیکربندی سیستم

در صورت نیاز به تغییر پیکربندی سیستم پشتیبان‌گیری و بازیابی، می‌توانید تنظیمات زیر را در فایل `db_backup.py` تغییر دهید:

### تعداد پشتیبان‌های نگهداری شده

برای تغییر تعداد پشتیبان‌های نگهداری شده، متغیر `MAX_BACKUPS` را تغییر دهید:

```python
# تعداد بکاپ‌های نگهداری شده
MAX_BACKUPS = 5  # می‌توانید این عدد را افزایش یا کاهش دهید
```

### فاصله زمانی پشتیبان‌گیری

برای تغییر فاصله زمانی پشتیبان‌گیری، متغیر `interval_hours` در بخش `if __name__ == "__main__"` را تغییر دهید:

```python
if __name__ == "__main__":
    interval_hours = 6  # پشتیبان‌گیری هر 6 ساعت
    # می‌توانید این عدد را تغییر دهید
```

## ترکیب با Docker

سیستم پشتیبان‌گیری و بازیابی به صورت خودکار در محیط Docker اجرا می‌شود. فایل `docker-compose.yml` به‌روزرسانی شده است تا:

1. پوشه `database_backups` را به عنوان یک volume به کانتینرها متصل کند.
2. اسکریپت‌های `db_backup.py` و `db_recovery.py` را به صورت خودکار اجرا کند.

### اجرای مجدد کانتینرها

پس از اعمال تغییرات، کانتینرها را با دستور زیر مجدداً راه‌اندازی کنید:

```bash
docker-compose down
docker-compose up -d
```

## عیب‌یابی

### مشکل در دسترسی به فایل‌های پشتیبان

اگر با مشکل دسترسی به فایل‌های پشتیبان مواجه شدید، دستور زیر را اجرا کنید:

```bash
sudo chmod -R 777 database_backups
```

### مشکل در اجرای اسکریپت‌ها

اگر با مشکل در اجرای اسکریپت‌ها مواجه شدید، مطمئن شوید که:

1. پکیج `psycopg2-binary` نصب شده است (در `requirements.txt` موجود است).
2. دسترسی‌های لازم برای ایجاد و خواندن فایل‌ها را دارید.

### خطای اتصال به دیتابیس

اگر با خطای اتصال به دیتابیس مواجه شدید، مطمئن شوید که:

1. کانتینر PostgreSQL در حال اجراست.
2. متغیرهای محیطی مربوط به دیتابیس در فایل `.env` به درستی تنظیم شده‌اند.

## پشتیبان‌گیری و بازیابی دستی (خارج از سیستم)

اگر به هر دلیلی سیستم خودکار پشتیبان‌گیری و بازیابی کار نکرد، می‌توانید از دستورات زیر برای پشتیبان‌گیری و بازیابی دستی استفاده کنید:

### پشتیبان‌گیری با pg_dump

```bash
docker exec -t instagram_bot_db pg_dump -U postgres -d instagrambot > manual_backup.sql
```

### بازیابی با psql

```bash
cat manual_backup.sql | docker exec -i instagram_bot_db psql -U postgres -d instagrambot
```

## نتیجه‌گیری

با استفاده از این سیستم پشتیبان‌گیری و بازیابی، می‌توانید اطمینان حاصل کنید که داده‌های دیتابیس شما در صورت بروز مشکل از بین نخواهند رفت. این سیستم به صورت خودکار عمل می‌کند و نیازی به دخالت کاربر ندارد، اما در صورت نیاز می‌توانید به صورت دستی نیز با آن کار کنید.